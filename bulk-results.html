<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=1">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1">
    <title>Transcription Archives & Reports | Speech-to-Text Pro</title>
    <meta name="description"
        content="Access, manage, and share your AI-generated transcription reports. Organize your transcribed content by date and collaborate with your team through our secure platform.">
    <meta name="keywords"
        content="transcription archives, video text reports, shared transcription results, ai report management, speech to text archives">
    <link rel="canonical" href="https://audio2text.mlopssol.com/bulk-results">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://audio2text.mlopssol.com/bulk-results">
    <meta property="og:title" content="Transcription Archives & Reports | Speech-to-Text Pro">
    <meta property="og:description"
        content="Manage and share your synthesized transcription reports. Keep your team in sync with high-accuracy video-to-text results.">
    <meta property="og:image" content="https://yourdomain.com/static/og-image.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://audio2text.mlopssol.com/bulk-results">
    <meta property="twitter:title" content="Transcription Archives & Reports | Speech-to-Text Pro">
    <meta property="twitter:description"
        content="Manage and share your synthesized transcription reports. Keep your team in sync with high-accuracy video-to-text results.">
    <meta property="twitter:image" content="https://yourdomain.com/static/og-image.jpg">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7297475514195167"
        crossorigin="anonymous"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        html,
        body {
            height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar Styling (Matching existing pages) */
        .sidebar {
            width: 230px;
            background: #111827;
            color: #e5e7eb;
            padding: 1.2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 0.03em;
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: .75rem;
            text-transform: uppercase;
            letter-spacing: .08em;
            color: #6b7280;
            margin-bottom: .3rem;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: .15rem;
            font-size: .86rem;
        }

        .sidebar li a {
            display: flex;
            align-items: center;
            gap: .45rem;
            padding: .45rem .6rem;
            border-radius: .45rem;
            color: #d1d5db;
            text-decoration: none;
            transition: all 0.2s;
        }

        .sidebar li a.active,
        .sidebar li a:hover {
            background: rgba(55, 65, 81, .8);
            color: #fff;
        }

        /* Main Panel */
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg);
        }

        .topbar {
            height: 60px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }

        .page-header {
            padding: 2rem;
            background: #fff;
            border-bottom: 1px solid var(--border);
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0;
            letter-spacing: -0.02em;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-top: 0.4rem;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }

        .date-group {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .date-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .date-text {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .date-line {
            height: 1px;
            background: var(--border);
            flex: 1;
        }

        /* Result Card */
        .result-card {
            background: var(--card-bg);
            border-radius: 1.2rem;
            border: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .result-meta {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .result-title {
            font-weight: 700;
            font-size: 1.15rem;
            color: #0f172a;
        }

        .result-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .result-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-action {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.6rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text-main);
        }

        .btn-action:hover {
            background: #f1f5f9;
        }

        .btn-share {
            background: var(--primary);
            color: #fff;
            border: none;
        }

        .btn-share:hover {
            background: var(--primary-light);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .result-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #334155;
            background: #f8fafc;
            padding: 1.25rem;
            border-radius: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #f1f5f9;
        }

        .result-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .url-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: #eff6ff;
            color: #2563eb;
            border-radius: 999px;
            border: 1px solid #dbeafe;
            text-decoration: none;
        }

        /* --- TABS SYSTEM --- */
        .tabs-container {
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
            border-radius: 0.8rem;
            overflow: hidden;
            background: #fff;
        }

        .tabs-nav {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #64748b;
            background: transparent;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #1e293b;
            background: #f1f5f9;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #fff;
        }

        .tab-content {
            padding: 20px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #334155;
            white-space: pre-wrap;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content.expanded {
            max-height: none;
        }

        .empty-state {
            text-align: center;
            padding: 5rem 2rem;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Modal Overlay (Copying styling from existing pages) */
        #groupManagementModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.35);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }

        .modal-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.35);
            padding: 32px 30px 26px 30px;
            min-width: 320px;
            max-width: 450px;
            width: 92vw;
            text-align: left;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }

        .input {
            width: 100%;
            border-radius: .6rem;
            border: 1.5px solid #c7d2fe;
            padding: .7rem .9rem;
            font-size: .9rem;
            background: #f8fafc;
            transition: border 0.2s;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        #member-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .member-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.4rem;
            cursor: pointer;
            padding: 0;
            margin-right: 15px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }

        @media (max-width: 900px) {
            .sidebar {
                position: fixed;
                left: -260px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .sidebar-toggle {
                display: block;
            }

            .topbar {
                padding: 0 1.2rem;
            }

            .page-header {
                padding: 1.5rem 1.2rem;
            }

            .page-title {
                font-size: 1.4rem;
            }

            .content-area {
                padding: 1.2rem;
                gap: 1.5rem;
            }

            .result-header {
                flex-direction: column;
                gap: 1rem;
            }

            .result-actions {
                width: 100%;
                justify-content: space-between;
            }

            .btn-action {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .result-card {
                padding: 1.2rem;
            }

            .result-title {
                font-size: 1rem;
            }

            .result-body {
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-text">
                <a href="https://mlopssol.com/" target="_blank">
                    <img src="/static/logo.png" alt="Speech-to-Text Pro - Transcription Archives"
                        style="height:48px;max-width:180px;vertical-align:middle;">
                </a>
            </div>

            <div>
                <div class="nav-section-title">Workspace</div>
                <ul>
                    <li><a href="/"><i class="fa-solid fa-wave-square"></i><span>Speech to Text</span></a></li>
                    <li><a href="/multi-video-transcription"><i class="fa-solid fa-list-check"></i><span>Batch
                                Transcription</span></a></li>
                </ul>
            </div>



            <div>
                <div class="nav-section-title">Discover MLOps</div>
                <ul>
                    <li><a href="https://www.mlopssol.com" target="_blank"><i class="fa-solid fa-rocket"
                                style="color:#818cf8;"></i><span>Official Website</span></a></li>
                </ul>
            </div>

            <div>
                <div class="nav-section-title">Support</div>
                <ul>
                    <li><a href="/contact"><i class="fa-solid fa-envelope"
                                style="color:#f472b6;"></i><span>Contact</span></a></li>
                </ul>
            </div>

            <div>
                <div class="nav-section-title">Account</div>
                <ul>
                    <li><a href="/billing"><i class="fa-solid fa-credit-card"></i><span>Billing</span></a></li>
                    <li><a href="#" id="logoutBtn"><i
                                class="fa-solid fa-arrow-right-from-bracket"></i><span>Logout</span></a></li>
                </ul>
            </div>
        </aside>

        <!-- Main Panel -->
        <main class="main-panel">
            <div class="topbar">
                <div style="display: flex; align-items: center;">
                    <button class="sidebar-toggle" onclick="toggleMobileMenu()">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <span id="welcomeName" style="font-weight: 600; color: var(--primary);">Loading...</span>
                </div>
                <i class="fa-solid fa-user-circle" style="font-size: 1.4rem; color: var(--primary);"></i>
            </div>

            <div class="page-header">
                <h1 class="page-title">AI Transcription Archives</h1>
                <p class="page-subtitle">Your synthesized reports, organized by date for easy sharing.</p>
            </div>

            <div class="content-area" id="archivesList">
                <div class="empty-state">
                    <i class="fa-solid fa-cloud-moon empty-icon"></i>
                    <p>Loading your archives...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Share Modal -->
    <div id="groupManagementModal">
        <div class="modal-card">
            <!-- View 1: List Groups -->
            <div id="groupListView">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h3 style="margin:0;font-size:1.1rem;color:#111827;font-weight:600;">Share With Group</h3>
                    <button id="showCreateGroupViewBtn"
                        style="padding:6px 12px;background:#059669;color:#fff;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;">
                        <i class="fa-solid fa-plus"></i> New
                    </button>
                </div>

                <div id="existingGroupsList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
                    <!-- Groups loaded here -->
                    <div style="text-align:center;color:#6b7280;padding:20px;">Loading...</div>
                </div>

                <div style="display:flex;justify-content:flex-end;">
                    <button onclick="closeModal()"
                        style="padding:8px 16px;background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;border-radius:7px;font-weight:600;cursor:pointer;">Close</button>
                </div>
            </div>

            <!-- View 2: Create Group -->
            <div id="groupCreateView" style="display:none;">
                <h3 style="margin:0 0 15px 0;font-size:1.3rem;color:#111827;font-weight:600;">Create New Group</h3>

                <div style="display:flex;flex-direction:column;gap:1rem;margin-bottom:20px;">
                    <div>
                        <label
                            style="display:block;font-size:0.85rem;color:#4b5563;font-weight:500;margin-bottom:5px;">Group
                            Name</label>
                        <input type="text" id="groupNameInput" class="input" placeholder="e.g. Content Team"
                            style="margin-bottom:0;">
                    </div>

                    <div>
                        <label
                            style="display:block;font-size:0.85rem;color:#4b5563;font-weight:500;margin-bottom:5px;">Add
                            Members (Emails)</label>
                        <input type="text" id="groupEmailsInput" class="input"
                            placeholder="alice@example.com, bob@example.com" style="margin-bottom:0;">
                        <div style="font-size:0.75rem;color:#6b7280;margin-top:4px;">Comma separated</div>
                    </div>
                </div>

                <div style="display:flex;justify-content:flex-end;gap:10px;">
                    <button onclick="showGroupList()"
                        style="padding:8px 16px;background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;border-radius:7px;font-weight:600;cursor:pointer;">Back</button>
                    <button id="submitCreateGroupBtn"
                        style="padding:8px 20px;background:#059669;color:#fff;border:none;border-radius:7px;font-weight:600;cursor:pointer;">Create</button>
                </div>
            </div>

            <div id="groupDetailsView" style="display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <button onclick="showGroupList()"
                            style="background:none;border:none;color:var(--text-muted);cursor:pointer;"><i
                                class="fa-solid fa-arrow-left"></i></button>
                        <h3 id="detailsGroupName" style="margin:0;font-size:1.1rem;font-weight:600;"></h3>
                    </div>
                    <button onclick="deleteCurrentGroup()" id="deleteGroupBtn" title="Delete Group"
                        style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:1rem;display:none;">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
                <div id="member-list-container">
                    <!-- Members loaded here -->
                </div>
                <div style="display:flex;justify-content:flex-end;gap:10px;">
                    <button id="sendBtn"
                        style="padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:7px;font-weight:600;cursor:pointer;">Send
                        Report</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pendingContent = "";
        let selectedGroupId = null;
        let currentGroupRole = "";

        // AUTH & UI
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        const userName = decodeURIComponent(getCookie("name") || "User");
        document.getElementById('welcomeName').innerText = `Welcome, ${userName}`;

        // LOAD DATA
        async function loadArchives() {
            const listDiv = document.getElementById('archivesList');
            try {
                const res = await fetch('/api/bulk-results', { credentials: 'include' });
                const data = await res.json();

                if (!data.results || data.results.length === 0) {
                    listDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fa-solid fa-folder-open empty-icon"></i>
                            <p>No reports found. Generate a topic-wise synthesis to see it here!</p>
                        </div>`;
                    return;
                }

                // Group by date
                const groups = {};
                data.results.forEach(r => {
                    const date = new Date(r.created_at).toLocaleDateString(undefined, {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    });
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(r);
                });

                listDiv.innerHTML = '';
                Object.keys(groups).forEach(date => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'date-group';

                    groupDiv.innerHTML = `
                        <div class="date-divider">
                            <span class="date-text">${date}</span>
                            <div class="date-line"></div>
                        </div>
                    `;

                    groups[date].forEach(res => {
                        const time = new Date(res.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const urls = res.urls.split(',');

                        const card = document.createElement('div');
                        card.className = 'result-card';

                        // Parse content for tabs
                        const tabsHtml = parseAndRenderTabs(`tabs-${res.id}`, res.content);

                        card.innerHTML = `
                            <div class="result-header">
                                <div class="result-meta">
                                    <div class="result-title">Topic-Wise synthesis Report</div>
                                    <div class="result-time"><i class="fa-solid fa-clock"></i> ${time} • ${urls.length} Videos processed</div>
                                </div>
                                <div class="result-actions">
                                    <button class="btn-action" onclick="copyText(this, 'tabs-${res.id}')"><i class="fa-solid fa-copy"></i> Copy Tab</button>
                                    <button class="btn-action btn-share" onclick="openShareModal(\`${res.id}\`)"><i class="fa-solid fa-paper-plane"></i> Share</button>
                                </div>
                            </div>
                            <div id="raw-content-${res.id}" style="display:none;">${res.content.replace(/</g, '&lt;')}</div>
                            <div class="result-body-container" id="content-${res.id}">
                                ${tabsHtml}
                            </div>
                            <div class="result-footer">
                                ${urls.map(u => `<a href="${u}" target="_blank" class="url-tag"><i class="fa-solid fa-link"></i> ${u.substring(0, 30)}...</a>`).join('')}
                            </div>
                        `;
                        groupDiv.appendChild(card);
                    });
                    listDiv.appendChild(groupDiv);
                });

            } catch (e) {
                listDiv.innerHTML = '<p style="color:red;text-align:center;">Failed to load reports. Please try again later.</p>';
            }
        }

        // ACTIONS
        function copyText(btn, containerId) {
            // Copy ONLY the active tab's content
            const container = document.getElementById(containerId);
            const activeTab = container.querySelector('.tab-content.active');
            const text = activeTab ? activeTab.innerText : "No content";

            navigator.clipboard.writeText(text).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = original, 2000);
            });
        }

        // TAB LOGIC
        window.switchTab = function (btn, tabId) {
            const container = btn.closest('.tabs-container');
            // Remove active class from all buttons and contents
            container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Activate clicked
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        };

        function formatContent(text) {
            if (!text) return "";

            const lines = text.split('\n');
            let html = "";
            let inList = false;

            lines.forEach(line => {
                const trimmed = line.trim();
                // Handle formatting inside lines (Bold, Italic, Link)
                const formatInline = (str) => {
                    return str
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                        .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
                        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#4f46e5; text-decoration:underline;">$1</a>'); // Auto-link
                };

                if (trimmed.length === 0) {
                    if (inList) { html += "</ul>"; inList = false; }
                    return;
                }

                if (trimmed.startsWith("### ")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<h3 style="font-size:1.1rem; font-weight:600; color:#111827; margin-top:1.5rem; margin-bottom:0.75rem; border-left: 3px solid #6366f1; padding-left: 10px;">${formatInline(trimmed.substring(4))}</h3>`;
                } else if (trimmed.startsWith("## ") || trimmed.startsWith("Category:")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    let title = trimmed.startsWith("## ") ? trimmed.substring(3) : trimmed;
                    if (title.startsWith("Category:")) title = title.substring(9).trim();
                    html += `<h2 style="font-size:1.25rem; font-weight:700; color:#111827; margin-top:1.5rem; margin-bottom:1rem; border-bottom:1px solid #e5e7eb; padding-bottom:8px;">${formatInline(title)}</h2>`;
                } else if (trimmed.startsWith("- ") || trimmed.startsWith("• ")) {
                    if (!inList) { html += '<ul style="margin-bottom:1rem; padding-left:1.5rem; color:#374151;">'; inList = true; }
                    html += `<li style="margin-bottom:0.4rem;">${formatInline(trimmed.substring(2))}</li>`;
                } else {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<p style="margin-bottom:0.8rem; line-height:1.7; color:#374151;">${formatInline(trimmed)}</p>`;
                }
            });

            if (inList) { html += "</ul>"; }
            return html;
        }

        function parseAndRenderTabs(containerId, fullText) {
            // Split Parts
            const split1 = fullText.split("COMPLETE TRANSCRIPTIONS FROM ALL SOURCES");
            let analysisText = split1[0] || "";
            let remainder = split1[1] || "";

            const split2 = remainder.split("Sources used in this synthesis:");
            let transcriptsText = split2[0] || "";
            let sourcesText = split2[1] || "";

            // Dynamic Categories Parsing
            const categoryMap = new Map();
            const categoryRegex = /## Category:\s*(.*?)\n([\s\S]*?)(?=## Category:|$)/g;

            analysisText = analysisText.trim();
            let match;
            let matchFound = false;

            while ((match = categoryRegex.exec(analysisText)) !== null) {
                matchFound = true;
                const name = match[1].trim();
                const content = match[2].trim();
                if (categoryMap.has(name)) {
                    categoryMap.set(name, categoryMap.get(name) + "\n\n" + content);
                } else {
                    categoryMap.set(name, content);
                }
            }

            const categories = Array.from(categoryMap.entries()).map(([name, content]) => ({ name, content }));

            if (!matchFound) {
                categories.push({ name: "General Analysis", content: analysisText });
            }

            // Build HTML
            let navHtml = "";
            let contentHtml = "";

            // 1. Category Tabs
            categories.forEach((cat, idx) => {
                const tabId = `${containerId}-cat-${idx}`;
                const isActive = idx === 0 ? "active" : "";
                navHtml += `<button class="tab-btn ${isActive}" onclick="switchTab(this, '${tabId}')">${cat.name}</button>`;
                contentHtml += `<div id="${tabId}" class="tab-content ${isActive}" style="white-space:normal;">${formatContent(cat.content)}</div>`;
            });

            // Metadata sections (Not in tabs)
            let metaHtml = "";
            if (transcriptsText.trim()) {
                metaHtml += `
                    <div style="margin-top:2rem; border-top:1px solid #e5e7eb; padding-top:1.5rem;">
                        <details style="cursor:pointer; background:#f9fafb; border-radius:10px; border:1px solid #e5e7eb;">
                            <summary style="padding:12px 20px; font-weight:700; color:#4b5563; list-style:none; display:flex; justify-content:space-between; align-items:center;">
                                <span><i class="fa-solid fa-file-lines" style="margin-right:8px;"></i> FULL TRANSCRIPTIONS</span>
                                <i class="fa-solid fa-chevron-down" style="font-size:0.8rem;"></i>
                            </summary>
                            <div style="padding:20px; background:#fff; border-top:1px solid #e5e7eb; max-height:400px; overflow-y:auto; font-size:0.9rem; line-height:1.6; color:#374151;">
                                ${formatContent(transcriptsText.trim())}
                            </div>
                        </details>
                    </div>
                `;
            }

            if (sourcesText.trim()) {
                metaHtml += `
                    <div style="margin-top:1rem;">
                        <details style="cursor:pointer; background:#f9fafb; border-radius:10px; border:1px solid #e5e7eb;">
                            <summary style="padding:12px 20px; font-weight:700; color:#4b5563; list-style:none; display:flex; justify-content:space-between; align-items:center;">
                                <span><i class="fa-solid fa-link" style="margin-right:8px;"></i> SOURCES USED</span>
                                <i class="fa-solid fa-chevron-down" style="font-size:0.8rem;"></i>
                            </summary>
                            <div style="padding:20px; background:#fff; border-top:1px solid #e5e7eb; font-size:0.9rem; color:#374151;">
                                ${formatContent(sourcesText.trim())}
                            </div>
                        </details>
                    </div>
                `;
            }

            return `
                <div class="tabs-container" id="${containerId}">
                    <div style="display:flex; justify-content:space-between; align-items:center; background:#f8fafc; border-bottom:1px solid #e5e7eb;">
                        <div class="tabs-nav" style="border-bottom:none; flex:1; background:transparent;">
                            ${navHtml}
                        </div>
                        <button onclick="toggleMaximize(this, '${containerId}')" title="Maximize" style="border:none; background:transparent; cursor:pointer; padding:0 15px; color:#64748b; transition:color 0.2s;">
                            <i class="fa-solid fa-expand"></i>
                        </button>
                    </div>
                    ${contentHtml}
                </div>
                ${metaHtml}
            `;
        }

        function toggleMaximize(btn, containerId) {
            const container = document.getElementById(containerId);
            const contents = container.querySelectorAll('.tab-content');
            const icon = btn.querySelector('i');

            // Toggle expanded class on all content divs within this container
            let isExpanded = false;
            contents.forEach(c => {
                c.classList.toggle('expanded');
                if (c.classList.contains('expanded')) isExpanded = true;
            });

            // Toggle Icon
            if (isExpanded) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
                btn.title = "Minimize";
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
                btn.title = "Maximize";
            }
        }

        function openShareModal(id) {
            // Try to get raw full content first to ensure we share everything
            const rawEl = document.getElementById(`raw-content-${id}`);
            if (rawEl) {
                pendingContent = rawEl.textContent || rawEl.innerText;
            } else {
                pendingContent = document.getElementById(`content-${id}`).innerText;
            }

            document.getElementById('groupManagementModal').style.display = 'flex';
            showGroupList(); // Always reset view
            loadGroups();
        }

        function closeModal() {
            document.getElementById('groupManagementModal').style.display = 'none';
        }

        function showGroupList() {
            document.getElementById('groupListView').style.display = 'block';
            document.getElementById('groupCreateView').style.display = 'none';
            document.getElementById('groupDetailsView').style.display = 'none';
        }

        async function loadGroups() {
            const list = document.getElementById('existingGroupsList');
            list.innerHTML = '<div style="text-align:center;color:#6b7280;padding:20px;">Loading...</div>';
            try {
                const res = await fetch('/api/groups/list', { credentials: 'include' });
                const data = await res.json();
                list.innerHTML = '';
                if (data.groups && data.groups.length > 0) {
                    data.groups.forEach(g => {
                        const div = document.createElement('div');
                        div.style.cssText = "padding:12px; border:1px solid #e2e8f0; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;";
                        div.onclick = () => openGroupDetails(g.id, g.name, g.role);
                        div.innerHTML = `<div><b>${g.name}</b><br><span style="font-size:0.8rem;color:var(--text-muted)">${g.member_count} members • ${g.role}</span></div><i class="fa-solid fa-chevron-right"></i>`;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = '<div style="text-align:center;color:#6b7280;padding:15px;background:#f9fafb;border-radius:8px;">No groups found. Create one!</div>';
                }
            } catch (e) { list.innerHTML = '<div style="color:red;text-align:center;">Error loading groups</div>'; }
        }

        document.getElementById('showCreateGroupViewBtn').onclick = () => {
            document.getElementById('groupListView').style.display = 'none';
            document.getElementById('groupCreateView').style.display = 'block';
        };

        document.getElementById('submitCreateGroupBtn').onclick = async function () {
            const btn = document.getElementById('submitCreateGroupBtn');
            const name = document.getElementById('groupNameInput').value.trim();
            const emailsStr = document.getElementById('groupEmailsInput').value.trim();

            if (!name) { alert("Group name is required"); return; }

            // Parse emails
            const emails = emailsStr ? emailsStr.split(',').map(e => e.trim()).filter(e => e.length > 0) : [];

            btn.disabled = true;
            btn.innerHTML = "Creating...";

            try {
                const res = await fetch('/api/groups/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_name: name, member_emails: emails }),
                    credentials: 'include'
                });
                const data = await res.json();

                if (res.ok) {
                    showGroupList();
                    document.getElementById('groupNameInput').value = '';
                    document.getElementById('groupEmailsInput').value = '';
                    loadGroups();
                } else {
                    alert("Error: " + data.error);
                }
            } catch (e) {
                alert("Failed: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "Create";
            }
        };

        async function openGroupDetails(id, name, role) {
            selectedGroupId = id;
            currentGroupRole = role;
            document.getElementById('detailsGroupName').innerText = name;
            document.getElementById('groupListView').style.display = 'none';
            document.getElementById('groupCreateView').style.display = 'none';
            document.getElementById('groupDetailsView').style.display = 'block';

            // Only show delete button if user is admin
            const deleteBtn = document.getElementById('deleteGroupBtn');
            if (deleteBtn) {
                deleteBtn.style.display = (role === 'admin') ? 'block' : 'none';
            }

            const list = document.getElementById('member-list-container');
            list.innerHTML = '<p>Loading members...</p>';
            try {
                const res = await fetch(`/api/groups/${id}/members`, { credentials: 'include' });
                const data = await res.json();
                list.innerHTML = '';
                data.members.forEach(m => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.style.display = 'flex';
                    item.style.alignItems = 'center';
                    item.style.justifyContent = 'space-between';

                    const left = document.createElement('div');
                    left.style.display = 'flex';
                    left.style.alignItems = 'center';
                    left.style.gap = '10px';
                    left.innerHTML = `<input type="checkbox" class="member-check" value="${m.email}"> <span>${m.email}</span>`;
                    item.appendChild(left);

                    if (currentGroupRole === 'admin' && m.email !== getCookie("email")) {
                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = '<i class="fa-solid fa-user-minus"></i>';
                        removeBtn.style.cssText = "background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.9rem;";
                        removeBtn.onclick = () => removeMemberFromGroup(m.email);
                        item.appendChild(removeBtn);
                    }
                    list.appendChild(item);
                });
            } catch (e) { list.innerHTML = 'Error loading members'; }
        }

        async function removeMemberFromGroup(memberEmail) {
            if (!confirm(`Remove ${memberEmail} from group?`)) return;
            try {
                const res = await fetch('/api/groups/remove-member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_id: selectedGroupId, email: memberEmail }),
                    credentials: 'include'
                });
                if (res.ok) {
                    alert("Member removed.");
                    openGroupDetails(selectedGroupId, document.getElementById('detailsGroupName').innerText, currentGroupRole);
                } else {
                    const d = await res.json();
                    alert("Error: " + d.error);
                }
            } catch (e) { alert("Error removing member."); }
        }

        async function deleteCurrentGroup() {
            if (!selectedGroupId) return;
            if (!confirm(`Are you sure you want to delete the group "${document.getElementById('detailsGroupName').innerText}"? This cannot be undone.`)) return;

            try {
                const res = await fetch('/api/groups/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ group_id: selectedGroupId }),
                    credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    alert("Group deleted successfully.");
                    showGroupList();
                    loadGroups();
                } else {
                    alert("Error: " + data.error);
                }
            } catch (e) {
                alert("Failed to delete group.");
            }
        }

        document.getElementById('sendBtn').onclick = async () => {
            const emails = Array.from(document.querySelectorAll('.member-check:checked')).map(cb => cb.value);
            if (emails.length === 0) { alert("Select at least one member."); return; }

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerText = "Sending...";

            try {
                const res = await fetch('/api/groups/share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        emails: emails,
                        content: pendingContent,
                        title: "Archived Topic-Wise Report"
                    }),
                    credentials: 'include'
                });
                if (res.ok) {
                    alert("Report shared successfully!");
                    closeModal();
                } else {
                    alert("Failed to share.");
                }
            } catch (e) { alert("Error sharing."); }
            btn.disabled = false;
            btn.innerText = "Send Report";
        };

        document.getElementById('logoutBtn').onclick = () => {
            closeMobileMenu();
            const cookies = ["loggedIn", "email", "name", "subscribed", "free_trial_used"];
            cookies.forEach(c => {
                document.cookie = `${c}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            });
            window.location.href = "/";
        };

        // MOBILE MENU LOGIC
        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('mobile-open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function closeMobileMenu() {
            document.querySelector('.sidebar').classList.remove('mobile-open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        loadArchives();
    </script>
</body>

</html>